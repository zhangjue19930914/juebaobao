M.add("soso-map",function(a){var b=a.io,c=a.Lang.isArray,d=a.Lang.trim,e=a.mt.util,f=a.mt.www,g=a.mt.Dialog,h=a.mt.lang;a.mt.www.Map={showBizMap:function(b,c){window.qq&&window.qq.maps?f.Map.printBizMap(b,c):M.load(function(){a.Get.js("http://map.qq.com/api/js?v=2.exp&callback=Y.mt.www.Map.callback",function(a){a||f.Map.printBizMap(b,c)})})},printBizMap:function(i,j){function k(){a.Array.each(y.get("markers"),function(a,b){a.setAnimation(x.MarkerAnimation.DROP),y.addListener(a,"click",function(){o(),z.openInfoWindow(b)})})}function l(){var b=i.shops;i.shops={},a.Object.each(b,function(a,b){a.name&&c(a.position)&&2===a.position.length&&(i.shops[b]=a)})}function m(){var b={container:w,markers:[],options:{scrollwheel:!0}};a.mix(b,i,!1,["center","zoom"]),a.Object.each(i.shops,function(a){b.markers.push({position:a.position,title:a.name})}),1!==b.markers.length||b.zoom||(b.zoom=16,b.center=b.markers[0].position),y=new a.mt.Map(b),k(),y.render(),y.get("map")&&F.on("click",function(){o()})}function n(){return i.shops?void E.each(function(a){a.delegate("click",function(a){a.preventDefault();var b=e.data(this,"id"),c=e.data(this,"poiid"),d=i.shops[b];d&&o(d,b,c)},".view-map"),a.delegate("click",function(a){a.halt();var b=e.data(this,"id"),c=i.shops[b];c&&p(c)},".search-path"),a.delegate("click",function(a){a.halt();var b=e.data(this,"id"),c=e.data(this,"poiid"),d=i.shops[b];d&&q(d,c)},".correct-poi")}):void E.each(function(a){a.all(".view-map, .search-path, .correct-poi").hide()})}function o(b,c,d){var e,f,j,k="",l=[],m=u(b,c),n=b?b.name:i.name;b&&(k='<a href="javascript:void(0)" class="correct-poi">信息纠错</a>'),n=m.markers.length>1?h.truncateStr(n,16,"..."):n,B=new g({id:H,width:"770px",content:a.Lang.sub(K.getHTML(),{title:n,errorToCorrect:k})}),B.open(),e=a.one("#"+H),f=e.one(".map-container"),B.on("close",function(){f.hide()}),e.delegate("click",function(a){a.halt();var b=i.shops[c];b&&d&&(B.close(),q(b,d))},".correct-poi"),e.delegate("click",function(){window._gaq.push(["_trackEvent","InnerLink","Click","map/view/close"])},".close"),z&&z.destroy(),z=v(e,m),z.render(),z.get("map")&&(1===m.markers.length?z.openInfoWindow(0):(j=e.one(".select-shop"),a.Object.each(i.shops,function(a,b){l.push('<option value="'+b+'">'+a.name+"</option>")}),j.append(l.join("")),j.show(),j.on("change",function(){var b=this.get("value"),c=a.Array.indexOf(A,b);z.openInfoWindow(c)})))}function p(b){var c=null;C=new g({id:I,width:"420px",title:"查询线路",content:a.Lang.sub(L.getHTML(),{shopName:b.name,shopLatLng:b.position.concat().reverse().join()})}),C.open(),c=a.one("#"+I),r(c)}function q(b,c){var d=null;M&&(D=new g({id:J,width:"520px",title:"信息报错",content:a.Lang.sub(M.getHTML(),{shopName:b.name,shopAddress:b.address,shopPhone:b.phone,poiid:c})}),D.open(),d=a.one("#"+J),s(d))}function r(a){var b=a.one("form"),c=a.one(".error"),d=e.field(b,"from");b.on("submit",function(a){return a.halt(),""===d.get("value")?(c.setHTML("请填写您的出发地").setStyle("display","block"),d.focus(),!1):(c.hide(),b.submit(),!0)})}function s(c){function g(){var a=d(k.get("value"));return a&&!k.hasClass("placeholder")||l.get("checked")||n.get("checked")?!1:!0}var h=c.one("form"),i=h.one('input[type="submit"]'),j=c.one("div.correct-group"),k=c.one("#correct-poi-info"),l=c.one("#number-error"),m=c.one(".field-group--error"),n=c.one("#connect-error");a.one("body").on("keydown",function(b){var c=b.keyCode;c===a.mt.macro.key.ESC&&D.close()}),h.delegate("click",function(a){var b=a.target,c=e.data(b,"phoneerror");"true"===c?(j.show(),j.one("input").focus()):j.hide()},'input[name="type"]'),k.plug(a.mt.plugin.Placeholder),h.on("submit",function(a){return a.halt(),g()?void m.show():(m.hide(),f.disableButton(i,!0),void b(h.get("action"),{method:"POST",form:{id:h},on:{success:function(a,b){var c=e.getEvalRes(b);t(c.status?!0:!1)},failure:function(){}}}))})}function t(a){var b,c=2;b=a?{type:"success",title:"提交成功！",tip:"感谢您的报错信息."}:{type:"failure",title:"提交失败",tip:"网络有问题，请稍候重试"},D.showResult(b),D.set("autoHide",c)}function u(b,c){var d=i.shops,e={center:[],defaultZoom:16,markers:[],infoWindows:[]};return b&&(d={},d[c]=b),A=[],a.Object.each(d,function(b,c){var d=[],f=a.Lang.sub(G,{destination:b.position.concat().reverse().join()});d.push('<div class="info-window"><h5>'+b.name+"</h5>"),b.address&&d.push('<p class="detail">'+b.address+"</p>"),b.phone&&d.push('<p class="detail">'+b.phone+"</p>"),d.push('<p><a href="'+f+'" target="_blank" gaevent="map/view/queryroute">公交/驾车路线查询&raquo;</a></p></div>'),e.markers.push({position:b.position,title:b.name}),e.infoWindows.push(d.join("")),A.push(c)}),e}function v(b,c){var d={container:b.one(".map-container"),options:{mapTypeControl:!0,zoomControlOptions:{style:x.ZoomControlStyle.LARGE},panControl:!0,scaleControl:!0}};return a.mix(c,d),new a.mt.Map(c)}var w,x=window.qq&&window.qq.maps;if(i&&x&&(!j||(w=a.one("#map-canvas")))){var y,z,A,B,C,D,E=a.all(".address-list"),F=w&&w.next(".J-view-full"),G="http://map.qq.com/?type=nav&tocoord={destination}&c={destination}&l=13",H="deal-view-map-dialog",I="deal-search-path-dialog",J="correct-poi-dialog",K=a.one("#view-map-markup"),L=a.one("#search-path-markup"),M=a.one("#correct-poi-markup");a.use("mt-map",function(){j&&(l(),m()),E&&n()}),a.Global.on("dealMapMarkers:change",function(b,c){var d=[];y.deleteMarkers(),a.Object.each(b.shops,function(a){d.push({position:a.position,title:a.name})}),y.set("markers",d),y.drawMarkers(),y.set("bounds",y.get("markers")),y.fitBounds(),k(),c&&c()})}},callback:function(){}},a.mt.ComponentHub.attach("soso-map",{ready:function(b){var c=b.component,d=c.params,e=d.callback;return e&&"function"==typeof e?void e():void a.mt.www.Map.showBizMap(d.mapData,d.flag)}})},"1.0.0",{requires:["www-base","mt-dialog"]});
M.add("www-ratelist",function(a){var b={buildSingleRatePicItem:function(a){var b,c,d,e;if(!a)return"";if(e=a.length,!e)return"";for(d='<div class="pic-list J-piclist-wrapper"><div class="J-pic-thumbnails pic-thumbnails"><ul class="pic-thumbnail-list">',b=0;e>b;b++)c=a[b],d+='<li data-src="'+c.url+'"><a class="pic-thumbnail" href="#" hidefocus="true">    <img src="'+c.url.replace("/w.h/","/126.126/")+'"/></a></li>';return d+='</ul></div><div class="J-pic-preview pic-preview"></div></div>'},renderRatePicList:function(b){if(b){var c=b.all(".J-piclist-wrapper");c.isEmpty()||a.use("w-carousel",function(a){c.each(function(b){new a.mt.widget.Carousel({contentBox:b,ndCarousel:".J-pic-preview",ndIndicatorWrap:".J-pic-thumbnails",fillLastPage:!0,getCarouselSrc:function(a){return a.getData("src").replace("/w.h/","/668.500/")}}).render()})})}}};a.namespace("mt.www.Ratelist"),a.mt.www.Ratelist=b},"1.0.0",{requires:["www-base"]});
M.add("www-sku",function(a){a.namespace("mt.www.Sku"),a.mt.www.Sku={initTypeSelection:function(a){var b,c,d,e,f,g="J-type-selected";a.delegate("click",function(){var h=a.one(".J-cart-quantity"),i=h.getData("max")-0;if(c=a.one("."+g),this.hasClass(g)||(this.addClass(g),a.one(".J-dealgood-id").set("value",this.getAttribute("data-dealgoodsid"))),c&&(c.removeClass(g),a.one(".J-dealgood-id").set("value","0")),c=a.one("."+g),d=a.one(".J-buy-form"),e=d.hasClass("deal-select-incomplete"),e?c&&(d.removeClass("deal-select-incomplete"),a.one(".J-remind-continue").show(),a.one(".remind__bottom").hide()):c||(d.addClass("deal-select-incomplete"),a.one(".J-remind-continue").hide(),a.one(".remind__bottom").show()),f=a.one(".deal-component-quantity-warning"),b=h.get("value")-0,f.setHTML(""),a.one(".J-type-selected")){var j=a.one(".J-type-selected").getData("dealgoodsrest");b>j&&i>j&&f.setHTML("还剩 "+j+"单")}},".J-type-select a")},initRemindClose:function(a){var b;a.delegate("click",function(){b=a.one(".J-buy-form"),b.removeClass("deal-buy-select-remind"),b.one(".J-type-remind").hide(),a.one(".deal-component-purchase-button").show()},".J-remind-close")},initNeedSelect:function(b,c,d){var e=a.one(".J-remind-continue"),f=b.currentTarget.cloneNode(!0);"INPUT"===f.get("tagName")?f.set("value","确定"):"A"===f.get("tagName")&&f.set("innerHTML","确定"),f.setAttribute("class",d+" btn J-select-continue"),f.removeAttribute("id"),e.setHTML(f);var g,h=184;c.one(".J-type-showall")&&""!==c.one(".J-type-showall").get("innerHTML")&&(c.one(".J-type-list").removeClass("type-list--fold"),c.one(".J-type-list").addClass("type-list--all"),g=parseInt(c.one(".J-type-list").get("scrollHeight"),10),g>h&&c.one(".J-type-select").addClass("type-showall-color-gradient"),c.one(".J-type-showall").remove(!0)),c.one(".J-buy-form").addClass("deal-buy-select-remind"),b.currentTarget.hasClass(d)||c.one(".J-select-continue").addClass(d),c.one(".deal-component-purchase-button").hide(),c.one(".J-type-remind").show();var i,j=a.UA.webkit?document.body:document.documentElement,k=a.one(".deal-component-container").getY();a.UA.ie&&a.UA.ie<9?window.scrollTo(0,k):(i=new a.Anim({node:j,duration:1,to:{scroll:[0,k]},easing:"easeOutStrong"}),i.run())},initTypeSelectAll:function(a){function b(b){var c,d,e=!0,f=92,g=184,h="type-list--fold",i="type-list--all",j='全部<i class="fold-tri fold-tri--down"></i>';b&&(c=b.ancestor().one(".J-type-list"),c&&(d=parseInt(c.get("scrollHeight"),10),f>=d||(b.setHTML(j),b.on("click",function(f){f.halt(),e&&(c.removeClass(h),c.addClass(i),d=parseInt(c.get("scrollHeight"),10),d>g&&a.one(".J-type-select").addClass("type-showall-color-gradient"),b.remove(!0))}))))}var c,d,e;for(c=a.all(".J-type-showall"),d=c.size(),e=0;d>e;++e)b(c.item(e))}}},"1.0.0");
M.add("www-add-cart",function(a){var b=a.io,c=a.mt.util;a.mt.www.AddCart={init:function(d,e,f){a.use("www-dialog","www-tracker",function(a){function g(b){var c;if(f===!0)return void(window.location.href="/cart/");if(c=b.recommendResult,void 0===c)l.createResultDialog({type:"success",title:"成功加入购物车！",tip:b.msg||"",extra:r},"",t),n.updateDropdownList();else{var d,e=a.one("#addcart-recdeal-markup"),g="cart-result-deals-dialog";d=new m({id:g,width:"590px",height:"360px",content:a.Lang.sub(e.getHTML(),{title:"成功加入购物车！",tip:b.msg||"",operate:r,deals:c})}),n.updateDropdownList(),d.open()}}function h(a){a=a||{},l.createResultDialog({type:"failure",title:"添加失败！",tip:a.msg||"",extra:s},"",t)}function i(){l.createResultDialog({type:"failure",title:"添加失败！",tip:"网络繁忙，请稍后再试。"},"",t)}var j,k=a.mt.www,l=k.Dialog,m=a.mt.Dialog,n=k.CartEx,o='<a href="javascript:void(0);" gaevent="content/main/addtocart/continue" class="close btn btn-cart btn-cart--left">&laquo;继续浏览</a>',p='<a href="/cart" gaevent="content/main/addtocart/cartcheckout" class="btn btn-hot btn-cart">去购物车结算&raquo;</a>',q='<a href="/cart" class="btn btn-hot btn-cart">整理购物车&raquo;</a>',r='<div class="operate">'+o+p+"</div>",s='<div class="operate">'+o+q+"</div>",t="cart-result-dialog";a.one("body").delegate("click",function(f){f.preventDefault();var l=c.data(f.currentTarget,"dealid"),m=c.data(f.currentTarget,"cityid"),n=a.one(".J-price-selection-container"),o=a.one(".J-price-id-input"),p=o?o.get("value"):0,q=0,r=1;if(e){var s=a.one(e);s&&(r=parseInt(s.get("value"),10)||1)}if(n){var t,u=!1,v=a.one(".deal-component-container").getY(),w=a.UA.webkit?document.body:document.documentElement,x=n.all(".J-price-selection");if(x.each(function(a){a.hasClass("deal-detail-selection-item--current")&&(u=!0,p=a.getData("priceid"))}),!u)return void(a.UA.ie&&a.UA.ie<9?(window.scrollTo(0,v),n.one(".price-selection").addClass("price-selection--confirm")):(t=new a.Anim({node:w,duration:1,to:{scroll:[0,v]},easing:"easeOutStrong"}),t.on("end",function(){n.one(".price-selection").addClass("price-selection--confirm")}),t.run()))}if(a.one(".deal-select-incomplete"))return void k.Sku.initNeedSelect(f,a.one(".deal-component-container"),d.substr(1));a.one(".J-type-selected")&&(q=a.one(".J-type-selected").getData("dealgoodsid"));var y="/cart/add/"+l+"/"+m;y=a.mt.www.tracker.appendTrackingParams(y),j&&j.isInProgress()&&j.abort(),j=b(y,{method:"POST",data:c.toPostData({quantity:r,calendarid:p,dealgoodsid:q}),on:{success:function(a,b){var d=c.getEvalRes(b);d.status?g(d):h(d)},failure:function(){i()}}})},d)})}}},"1.0.0",{requires:["www-base","www-dialog","www-tracker","www-sku"]});
M.add("www-deal",function(a){var b=a.io,c=a.DOM,d=a.UA.ie,e=6===d,f=a.Lang.isArray,g=a.Lang.trim,h=a.mt.util,i=a.mt.www,j=a.mt.www.tracker,k=a.mt.Dialog,l=a.mt.www.Ratelist;a.namespace("mt.www.Deal"),a.mt.www.Deal={COUNT_PER:3,scoreRankCache:{},refresh:function(b){function c(a,b){if(1>a)return void window.location.reload();var d=b&&b.one("span"),e=parseInt(a/86400,10),f=parseInt(a/3600%24,10),g=parseInt(a/60%60,10),h=parseInt(a%60,10),i=[];!d||e>0||(f>0?(i.push("<strong>"+f+"</strong>小时"),i.push("<strong>"+g+"</strong>分"),i.push("<strong>"+h+"</strong>秒")):g>0?(i.push("<strong>"+g+"</strong>分"),i.push("<strong>"+h+"</strong>秒")):i.push("<strong>"+h+"</strong>秒"),d.setHTML(i.join("")),a--,window.setTimeout(function(){c(a,b)},1e3))}b=f(b)?b:[b],a.Array.each(b,function(b){var d=a.one("#deal-timeleft-"+b);d&&d.hasClass("deal-on")&&c(d.getAttribute("diff"),d)})},Tracker:{init:function(){i.trackPageScroll("deal/scroll")}},SideTopic:{init:function(){M.load(function(){a.use("w-slider",function(a){var b=new a.mt.widget.Slider({srcNode:"#J-side-topic",effect:"slideFadeIn",sheetContainer:".J-side-topic-list",previous:".side-box--topic--previous",next:".side-box--topic--next",width:239,interval:2e3});b.render()})})}},NavBuyBtn:{update:function(b,c){if(c&&b){var d=a.one(document.createDocumentFragment());d.appendChild(c),b.setHTML(d.get("firstChild").get("innerHTML")),d=null}}},BottomBuyBtn:{update:function(a,b){b&&a&&a.setHTML(b)}},MyReview:{update:function(b,c){var d=a.JSON.parse(c);if(d.blkMyReview&&b){b.append(d.blkMyReview);var e,f,g=a.one(".to-rate"),h="";g&&g.hide(),d.picinfo&&(h=a.Node.create(l.buildSingleRatePicItem(d.picinfo)),e=a.one(".J-myreview"),f=e.one(".J-normal-view"),f.appendChild(h),l.renderRatePicList(e))}}},UserReviews:{update:function(b,c){var d=a.JSON.parse(c);if(d.showFeedback&&b){var e=a.mt.www.Deal;e.initUserReviews({dealId:d.dealid,cityId:d.cityid,isLogin:d.isLogin,loginRef:d.loginRefForFeedback})}}},MovieSchedule:{update:function(b,c){if(c&&b){var d=a.one(document.createDocumentFragment());d.appendChild(c),b.setHTML(d.get("firstChild").get("innerHTML")),d=null;var e=a.mt.www.Deal,f="#movie-schedule";a.mt.www.ImageLazyLoader.init(f),e.initMovieInfo(f)}}},BizsPoiInfo:{update:function(b,c){var d=a.JSON.parse(c);if(b&&d){var e=a.JSON.parse(b.getData("bizsConfig")),f=e.dealId,g=e.cityId,h=e.geoList;a.mt.www.Deal.initBizsPoi(f,g,h,e,d)}}},initDynamicInfo:function(c){function d(b){var c=a.one("#bd");if(b.getStatusTip&&c&&M.load(function(){a.use("www-tips",function(a){a.mt.www.SysMsg.init(b.getStatusTip,"#bd")})}),b.blkDirectedUserDialog||b.blkPC2MobileDialog||b.blkMagiccard181Dialog||b.campaignMagiccardDialog){var d=a.Node.create("<div></div>"),e={id:"welcome-dialog",width:380};if(b.blkMagiccard181Dialog)d.setHTML(b.blkMagiccard181Dialog);else if(b.blkPC2MobileDialog)d.setHTML(b.blkPC2MobileDialog);else if(b.blkDirectedUserDialog){var f,g,h=a.Node.create("<div></div>"),j={width:380};h.setHTML(b.blkDirectedUserDialog),c.append(h),f=a.one("#directedUser-dialog-markup"),j.content=f.getHTML(),g=new k(j),g.open()}else if(b.campaignMagiccardDialog){var l,m,n=a.Node.create("<div></div>"),o={width:380};n.setHTML(b.campaignMagiccardDialog),c.append(n),l=a.one("#campaignEvent-dialog-markup"),o.content=l.getHTML(),m=new k(o),m.open()}c.append(d);var p=a.one("#welcome-dialog-markup"),q=document.location.search;if(p&&q.indexOf("urpid=tenpay%7C_%7C")<0){e.content=p.getHTML();var r=new k(e);r.open()}}b.blkPC2MobileTip&&c.prepend(b.blkPC2MobileTip),i.selectAndCopy("#share-copy-text","#share-copy-button")}var e=c.action,f=c.method||"GET",g=c.cb||null,j="referrer"in document?document.referrer:window.location.href;-1===e.indexOf("?")&&window.location.search&&(e+=window.location.search),j&&(e+=(-1===e.indexOf("?")?"?":"&")+"__referer="+encodeURIComponent(j));var l=a.Lang.now();b(e,{method:f,on:{success:function(a,b){var c=h.getEvalRes(b);i.trackApiTiming(c.bem||null,l,"deal-dynamic"),g?g.call(null,b.responseText):c.status&&d(c.data)}}})},initBizsPoi:function(b,c,d,e,f){function g(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&(b=b.concat(a[c]));return b}var h=this,i={},j=a.one(".J-biz-wrapper"),k=a.one("#J-bizinfo-list");k&&(e=e||{},i[c]=f[c]||g(f),k.setData("poiList",i),k.setData("actionUrl","/deal/poilist/"+b),k.on("poiChange",function(){h.updateBizMapPOI(k)}),this.initBizInfo(k,i[c],e),f&&(e.geoInMultiCity||f.length>3)&&h.initPOIFilter(k,d,c,e),j.addClass("inited"))},initPOIFilter:function(b,d,e,f){function g(a,b,c){var d="";return c=c||0,d+='<select class="biz-filter dropdown--small">',d+=h(a,b,c),d+="</select>"}function h(a,b,c){var d,e="";c=+c,b&&(e='<option value="0">'+l[b]+"</option>");for(d in a)a.hasOwnProperty(d)&&"0"!==d.toString()&&(e+="<option "+(+a[d].id===c?' selected="selected"':"")+'value="'+a[d].id+'">'+a[d].name+"</option>");return e}function i(){var e,g,i,k,l,n,o,p,q=a.one(".J-filter-wrapper"),r=0;j=q.all("select"),j.each(function(a){r++,a.setData("index",r)}),j.each(function(a){a.on("change",function(){function a(a,c){var d=[];d.push(b),d.push(a),d.push(c),d.push(i),2===e&&d.push(l),3===e&&(d.push(l),d.push(p)),m.getPOIMapDataByFilter.apply(m,d)}e=this.getData("index"),i=j.item(0).get("value"),g=d[i]||{},n=j.item(1),o=j.item(2),l=+n.get("value"),k=g.district[l]||{},p=+j.item(2).get("value"),(1===e||2===e)&&(1===e&&(l=0,n.getDOMNode().options.length=0,n.appendChild(c.create(h(g.district,"dis",l)))),p=0,o.getDOMNode().options.length=0,o.appendChild(c.create(h(k.range,"range",p)))),a("bizData",function(a){m.initBizInfo(b,a,f),b.fire("poiChange")})})})}var j,k,l={dis:"全部城区",all:"全国",range:"全部商圈"},m=this;k='<div class="J-filter-wrapper biz-filter-wrapper">',k+='<span class="biz-filter-title">位置筛选:</span>',d[e]?(k+=g(d,"0"===e.toString()?"all":"",e),k+=g(d[e].district,"dis",0),k+=g([],"range",0)):(k+=g(d,"all",e),k+=g([],"dis",0),k+=g([],"range",0)),k+="</div>",b.insert(c.create(k),"before"),i()},initMapData:function(b){var c,d=a.one("#J-bizinfo-list"),e=this;d&&(c=d.getData("toShowMapList"),c&&(b.shops=c),d.setData("mapData",b),a.use("soso-map",function(a){e.toggleMapLoadingMask(!1),a.mt.www.Map.showBizMap(b,!0)}))},getPOIMapDataByFilter:function(c,d,e,f,g,i){function j(){return s?void k():void b(t,{method:"GET",on:{success:function(b,c){var d=h.getEvalRes(c);a.mix(r,d),s=r[f]||a.Object.values(r).shift(),k()},failure:function(){}}})}function k(){"0"===f.toString()?l():i&&0!==i?l("rangeid",i):g&&0!==g?l("disid",g):0===i?l("disid",g):l(),"mapData"===d?(o=c.getData("mapData"),o.shops=v,e(o)):"bizData"===d&&e(u),u=null,v=null}function l(a,b){"mapData"===d?m(a,b):n(a,b)}function m(a,b){for(p=0;p<s.length;p++)q=s[p],q&&(a?q[a].toString()===b.toString()&&(q.position=h.decodeJSON(q.latlng),v[q.shopid]=q):(q.position=h.decodeJSON(q.latlng),v[q.shopid]=q))}function n(a,b){if(a)for(p=0;p<s.length;p++)q=s[p],q&&q[a].toString()===b.toString()&&u.push(q);else u=u.concat(s)}var o,p,q,r=c.getData("poiList"),s=r[f],t=c.getData("actionUrl"),u=[],v={};j()},toggleMapLoadingMask:function(b){var c=a.one("#J-map-loading");c&&(b?c.show():c.hide())},updateBizMapPOI:function(b){var c=b.getData("mapData"),d=this;c&&(this.toggleMapLoadingMask(!0),c.shops=b.getData("toShowMapList"),window.setTimeout(function(){a.Global.fire("dealMapMarkers:change",c,function(){d.toggleMapLoadingMask(!1)})},50))},initBizInfo:function(a,b,c){var d;a&&b&&(d=a.ancestor(".biz-wrapper"),this.renderPOIList(a,b,1,c),this.initBizPageNav(a,b,c),!d.one(".J-bizs-link")&&b.length<=this.COUNT_PER?d.addClass("biz-wrapper-nobottom"):d.removeClass("biz-wrapper-nobottom"))},initBizPageNav:function(b,d,e){var f,g,h=this;b&&(f=b.ancestor().one(".paginator"),f&&f.remove(!0),d.length<=this.COUNT_PER||(f=b.ancestor().appendChild(c.create('<div class="paginator"></div>')),a.use("www-pagenav",function(){var c=Math.ceil(d.length/h.COUNT_PER),i={currentPage:1,maxPage:c,showNavCount:3,hasHeadEnd:!1};g=new a.mt.www.PageNav(f,function(a){h.renderPOIList(b,d,a.index,e),b.fire("poiChange"),i.currentPage=a.index,g.render(i)}),g.render(i)})))},renderPOIList:function(c,d,e,f){var g,i="",j="",k={},l=[],m=d.length,n=this;f=a.merge(f),f.reservationPhoneNumber=c.getData("reservationPhoneNumber")||"",f.noReservationPhone=c.getData("noReservationPhone"),e=(e-1)*this.COUNT_PER;for(var o=e;o<e+this.COUNT_PER&&m>o;o++)g=d[o],g.position=h.decodeJSON(g.latlng),i+=this.renderPOIItem(g,f,o===e,1===m),k[g.shopid]=g,n.scoreRankCache[g.poiid]||l.push(g.poiid);l.length&&(j="/deal/poicompare/"+l.join(","),b(j,{method:"get",on:{success:function(b,c){var d=h.getEvalRes(c);if(d)for(var e=null,f="",g=null,i=0,j=d.length;j>i;i++)g=d[i],f=g.poiid,n.scoreRankCache[f]=g,e=a.one("#biz-scorerank"+f),e&&e.setHTML(n.fillScoreRank(g))}}})),c.setData("toShowMapList",k),c.setHTML(i),this.initMapData(a.JSON.parse(c.getData("mapConfig"))),a.mt.widget.init(c),a.Global.fire("PageHeight:change")},fillScoreRank:function(b){var c="",d={title:"",scoreShort:"",score:"",rank:"",rankPercentage:"",rankClass:"",arrowText:""},e=b.ranklist,f='<div class="biz-item scorerank-item"><span class="title-label" style="visibility: hidden;">{title}：</span><span class="scorerank-item__score" title="{score}">{scoreShort}分</span><span class="scorerank-item__rank {rankClass}"><span class="scorerank-item__text">{rank}<span class="scorerank-item__percentage">{rankPercentage}</span></span><i class="arrow">{arrowText}</i></span></div>';c="";for(var g=0,h=e.length;h>g;g++){var i=e[g];"0.0"!==Number(i.score).toFixed(1)&&(d.title=i.title,d.score=i.score,d.scoreShort=Number(i.score).toFixed(1),i.scorerank>0?(d.rankClass="rank-up",d.rank="高于同行业",d.arrowText="",d.rankPercentage=Number(i.scorerank).toFixed(1)+"%"):i.scorerank<0?(d.rankClass="rank-down",d.rank="低于同行业",d.arrowText="",d.rankPercentage=Math.abs(i.scorerank).toFixed(1)+"%"):(d.rankClass="rank-normal",d.rank="与同行业持平",d.arrowText="--",d.rankPercentage=""),c+=a.Lang.sub(f,d))}return c},renderPOIItem:function(b,c,d,e){function f(a,b,c){for(var d,e=/[^a-zA-Z\s]/,f=c;f<a.length;f++)if(e.test(a.charAt(f)))return d=a.split(""),d.splice(f,b,"..."),d.join("");return""}function i(a){var b=a.replace(/[^\u4e00-\u9fa5\uFE30-\uFFA0\s]/g,"").length;return parseInt((a.length-b)/2+b,10)}function j(a){return 2===a.length&&a[0]&&a[1]&&a[0]-3.8>1e-7&&53.5-a[0]>1e-7&&a[1]-73.6>1e-7&&135-a[1]>1e-7?!0:!1}function k(a){a.length>t&&(q=i(a)-t,q>0&&(a=f(a,q,5))),s.bizName=a}function l(a){if(a){var c,d=a.fbcount||0;c=d>0?'<span class="biz-info__text"><span class="biz-info__rate-count">'+d+"人评价</span></span>":'<span class="biz-info__text">暂无评价</span>',s.bizRates='<div class="biz-item">评价：<a title="商家历史团购累积评分" gaevent="content/detail/poirank" class="biz-info__link" target="_blank" href="/shop/'+b.poiid+'#evaluate-box">'+c+"</a></div>"}}function m(a,b){if(!a||a.fbcount<1)s.bizScoreRank="";else{var c="",d=u.scoreRankCache[b];d&&(c=u.fillScoreRank(d)),s.bizScoreRank='<div id="biz-scorerank'+b+'">'+c+"</div>"}}var n,o,p,q,r=a.one("#deal-poilist-markup"),s={currentBiz:"",poiLink:"",bizName:"",fullBizName:"",bizAddress:"",title:"",searchPath:"",bizLevel:"",bizScoreRank:"",subway:"",phone:"",hotelAppointmentInfo:"",reservationPhoneNumber:""},t=15,u=this;if(d&&(s.currentBiz=" biz-info--open biz-info--first"),e&&(s.currentBiz+=" biz-info--only"),s=s||{},p=b.name,c.isPOIMultiCity&&b.cityname&&(p+="("+b.cityname+")"),!c.hidephone&&b.phone)if(s.phone='<div class="biz-item" data-uix="tooltip" data-params="{showEvent: \'click\'}"></div>',c.reservationPhoneNumber){var v="预约电话： ";"1"===c.noReservationPhone&&(v="电话： "),s.phone+='<div class="biz-item"><span class="title-label">'+v+"</span>"+c.reservationPhoneNumber+"</div>"}else s.phone+='<div class="biz-item"><span class="title-label">电话：</span>'+b.phone+"</div>";return s.fullBizName=p,k(p),l(b.poilevel),m(b.poilevel,b.poiid),b.poiid&&(s.poiLink="http://"+(b.cityfirstalpha?b.cityfirstalpha:"www")+"."+M.DOMAIN_HOST+"/shop/"+b.poiid),b.subwayname&&(n=g(b.subwayname),n.lastIndexOf("站")===n.length-1&&(n=n.substring(0,n.lastIndexOf("站"))),s.subway='<div class="subway-distance biz-item"><span class="title-label">地铁：</span>距'+n+"站约"+b.subwaydis+"米</div>"),b.latlng&&(o=h.decodeJSON(b.latlng),j(o)&&(s.searchPath='<div class="biz-item link-item"><a class="view-map" href="javascript:void(0)" data-id="'+b.shopid+'" data-poiid="'+b.poiid+'"'+a.mt.www.getMTEventAttr({shopid:b.shopid,poiid:b.poiid,la:"deal/viewmap"})+' gaevent="content/detail/map/detail">查看地图</a><a class="search-path" href="javascript:void(0)" data-id="'+b.shopid+'" gaevent="content/detail/map/drive">公交/驾车去这里</a></div>')),a.mix(s,{bizAddress:b.address,title:b.address},!0),a.Lang.sub(r.getHTML(),s)},initReferralLotteryDialog:function(){function b(){if(c)c.open();else{var b=a.one("#referral-lottery-dialog-markup");c=new k({id:d,title:"本单说明",width:"580px",content:b.getHTML()}),c.open(),a.one("#"+d+" .J-view-detail").on("click",function(){c.close(),window.location.href=g})}}var c,d="referral-lottery-dialog",e=a.one("#referral-lottery-link"),f="#anchor-referral-lottery",g=a.one(f)?f:"#anchor-detail";e&&e.on("click",function(){b()})},addFavorite:function(b,c){function d(){n&&n.isInProgress()||(n=a.io("/collection/add/"+b,{method:"POST",data:{url:t},on:{success:function(a,b){var c=h.getEvalRes(b);2===c.status?g():1===c.status?f():0===c.status?(i.Dialog.alert(c.msg),e()):i.Dialog.alert("网络有问题，请稍后重试")},failure:function(){}}}))}function e(){if(l){l.replaceClass(c,"in-favorite"),l.setAttribute("title","您已经收藏过本单");var a=l.one(".J-fav-count");if(a){var b=0|a.getHTML();a.setHTML(b+1),a.addClass("orange")}}}function f(){l&&(e(),a.use("w-simpledialog",function(){var b=new a.mt.widget.SimpleDialog({id:"add-favorite-dialog",node:l,width:160,content:a.one("#J-favorite-dialog").getHTML(),location:"tl",autoHide:2e3});b.open()}))}function g(){a.use("www-dialog",function(){m?m.open():m=i.Dialog.login({origin:"deal-favorite",galabel:"deal/favorite/login"})})}function j(){var a=h.Cookie.getExpiresDate(1,0,0);h.Cookie.set(r,b,a,"/","."+M.DOMAIN_HOST)}function k(){h.Cookie.remove(r,"/","."+M.DOMAIN_HOST)}c=c||"add-favorite";var l,m,n,o,p,q,r="addfav",s=a.one("."+c),t=location.href;s&&(p=s.getData("login"),q="false"===p?!1:!0,o=parseInt(h.Cookie.get(r),10),b=parseInt(b,10),q&&o===b?(k(),d()):a.one("body").delegate("click",function(a){l=a.currentTarget,a.preventDefault(),q?d():(j(),g())},"."+c))},handleWeddingContactSubmission:function(c){function d(){var d=a.one("#deal-weddingPhone-markup"),e="";if(!d)return e;var f=d.getHTML();return b("/deal/mobilecontact/"+c,{method:"GET",sync:!0,on:{success:function(b,c){var d=h.getEvalRes(c),g=h.decodeJSON(d.mobile);null===g&&(g=""),e=a.Lang.sub(f,{mobile:g})},failure:function(){}}}),e}var e;a.one("body").delegate("click",function(b){b.halt();var c=a.one(".J-error-wedding");c&&"none"!==c.getStyle("display")&&c.setStyle("display","none");var f=d(),g=b.target;a.use("w-bubbletip",function(a){e||(e=new a.mt.widget.BubbleTip({node:g,id:"wdBubbleTip",alignment:"bottom",showClose:!0,forceClose:!0,showType:"click",tip:f})),e.render(),e.show()})},".J-component-contact-phone-service")},initMobileOnlyDialog:function(){function c(){if(m)m.open();else{var b=a.one("#download-cli-dialog-markup"),c=b.getAttribute("isseckill")?"520px":"820px";m=new k({id:q,title:"扫描二维码，立即去抢购",width:c,content:b.getHTML()}),n=m.one("form"),p=h.field(n,"mobile"),o=h.field(n,"captcha"),n&&d(),m.open()}}function d(){a.use("mt-formchecker",function(a){var c,d,g=a.mt.FormChecker,k=n.get("action");p.plug(a.mt.plugin.Placeholder),i.refreshCaptcha(n,!0),d=new g({form:n,fields:{mobile:{node:p,validateFn:f,typeTip:"填写手机号，下载地址将发送到您的手机上"},captcha:{node:o,validateFn:j}},tipClass:g.CLASS_BLOCK_TIP}),n.on("submit",function(a){a.halt(),c&&c.isInProgress()||(c=b(k,{method:"POST",form:{id:n},on:{success:function(a,b){var c=h.getEvalRes(b);c.status?e(!0):e(!1,c.msg)},failure:function(){}}}))})})}function e(a,b){var c,d=5;c=a?{type:"success",title:"短信发送成功！",tip:"短信可能有延迟，请耐心等待"}:{type:"failure",title:"短信发送失败！",tip:b},m.showResult(c),m.set("autoHide",d),m=null}function f(){var a=p.get("value"),b=/^0{0,1}(13[0-9]|15[0-9]|18[0-9])[0-9]{8}$/;return 0===a.length?"手机号不能为空":b.test(a)?!1:"请输入11位手机号码"}function j(){var a=g(o.get("value")).length;return 0===a?"验证码不能为空":4!==a?"请输入正确的验证码":!1}var l=a.one(".deal-buy--mobileonly");if(l&&!+l.getData("hasinit")){l.setData("hasinit",1),l.get("disabled")&&l.set("disabled",!1);var m,n,o,p,q="download-cli-dialog";l&&l.on("click",function(a){a.preventDefault(),c()})}},initDetailNavbar:function(b){function c(){var a=q.get("pageYOffset"),c=b.one(".buy-group"),f=u>a?"up":"down";u=a,"up"===f?a<h.getY()?(c&&c.hide(),b.removeClass(r),l.hide(),e&&b.setStyle("top","auto")):e&&b.setStyle("top",a):a>h.getY()&&(b.addClass(r),c&&c.show(),b.next("."+t)?l.show():b.insert(l,"after"),e&&b.setStyle("top",a)),d()}function d(){function a(){m.each(function(a){a.ancestor("li").removeClass(s)}),m.filter('[data-anchor="'+w[d][0]+'"]').item(0).ancestor("li").addClass(s)}for(var c=0,d=0,e=b.getY()+p;c<w.length;){if(o&&e>=o)m.each(function(a){a.ancestor("li").removeClass(s)});else{if(!(e>=w[c][1])){a();break}d=c,c===w.length-1&&a()}c++}}function f(){var b=[];m.each(function(c){var d=c.getData("anchor"),e=a.one(d),f=[];e&&(f[0]=d,f[1]=e.getY(),b.push(f))}),o=n.get("region").bottom,w=b}function g(b){var c,d,e,f,g,h,k,l,m=a.UA.webkit?document.body:document.documentElement,n=a.one(b),o=a.one(".J-cart-quantity"),p=a.one(".J-price-id-input"),q=!1,r=p?p.get("value"):0;n&&n.delegate("click",function(b){return b.halt(),e=a.one(".J-price-selection-container"),c=a.one(".J-type-selected"),d=a.one(".deal-select-incomplete"),f=a.one(".deal-component-container").getY(),h=this.get("href"),k=o?"?q="+o.get("value"):"?q=1",d?(i.Sku.initNeedSelect(b,a.one(".deal-component-container"),"J-buy"),void(a.UA.ie&&a.UA.ie<9?window.scrollTo(0,f):(l=new a.Anim({node:m,duration:1,to:{scroll:[0,f]},easing:"easeOutStrong"}),l.run()))):(c&&(k+="&dealgoodsid="+c.getAttribute("data-dealgoodsid")),void(e?(g=e.all(".J-price-selection"),g.each(function(a){a.hasClass("deal-detail-selection-item--current")&&(q=!0,r=a.getData("priceid"))}),q?(k+="&calendarid="+r,window.location.href=j.appendTrackingParams(h+k)):a.UA.ie&&a.UA.ie<9?(window.scrollTo(0,f),e.one(".price-selection").addClass("price-selection--confirm")):(l=new a.Anim({node:m,duration:1,to:{scroll:[0,f]},easing:"easeOutStrong"}),l.on("end",function(){e.one(".price-selection").addClass("price-selection--confirm")}),l.run())):(0!==r&&(k+="&calendarid="+r),window.location.href=j.appendTrackingParams(h+k))))},".J-buy")}var h,k,l,m,n,o,p,q=M.window,r="common-fixed",s="content-navbar__item--current",t="common-fix-placeholder",u=0,v=10,w=[];b=a.one(b),b&&!e&&(m=b.all("[data-anchor]"),0!==m.size()&&(p=b.get("offsetHeight")+v+5,n=a.one(m.item(m.size()-1).getData("anchor")),h=b.ancestor(),k=parseInt(b.getComputedStyle("height"),10),l=a.Node.create('<div class="'+t+'" style="height:'+k+'px;"></div>'),a.Global.on("PageHeight:change",function(){f(),d()}),a.all("#deal-stuff img").each(function(a){a.getAttribute("height")||a.on("load",function(){f(),d()})}),g(".deal-component-container"),g(b),g("#J-bottom-buy"),f(),q.scroll(c,12)))},initMovieInfo:function(c){var d=a.one(c);if(d){var e,f=d.one(".accordion-content");f&&f.plug(a.mt.plugin.Effect),d.delegate("click",function(){var c=this.ancestor(".accordion-tab"),f=c.one(".accordion-content"),g=d.one(".biz-link"),i=h.data(c,"id"),j=g.getAttribute("href").replace(/\d+#/,i+"#");f?("none"===f.getStyle("display")?f.effect.slideDown():f.effect.slideUp(),c.toggleClass("accordion-tab-selected")):(c.append('<div class="accordion-content" style="display:none;"><a gaevent="dealmovie/movieshop" class="biz-link" href="'+j+'" target="_blank">查看详细排片表 &raquo;</a></div>'),f=c.one(".accordion-content"),f.plug(a.mt.plugin.Effect),e&&e.isInProgress()&&e.abort(),e=b("/deal/movieshows/"+i,{method:"GET",on:{success:function(a,b){var d=h.getEvalRes(b),e=d.data,g=d.hasSeatSelection;g&&f.one(".biz-link").setHTML("影院在线选座 &raquo;"),f.appendChild(e),f.effect.slideDown(),c.toggleClass("accordion-tab-selected")},failure:function(){}}}))},".accordion-label"),d.delegate("click",function(){var a=this;if(!a.hasClass("current")){var c,d=a.ancestor(".accordion-tab"),f=d.one(".accordion-content"),g=f.one(".current"),i=h.data(g,"date"),j=f.one(".c-"+i),k=h.data(a,"date"),l=f.one(".c-"+k);l?(j.hide(),l.show(),g.removeClass("current"),a.addClass("current"),f.setStyle("height","auto")):(c=h.data(d,"id"),e&&e.isInProgress()&&e.abort(),e=b("/deal/movieshows/"+c+"/"+k,{method:"GET",on:{success:function(b,c){var d=h.getEvalRes(c),e=d.data;j.hide(),f.append(e),f.setStyle("height","auto"),g.removeClass("current"),a.addClass("current")},failure:function(){}}}))}},".date-label")}},initUserReviews:function(c){function d(){g&&g.on("click",function(a){a.preventDefault();var c,d="/deal/checkfeedback/"+n;o?c=b(d,{method:"POST",on:{success:function(a,b){var c=h.getEvalRes(b),d=c.data;2===c.status?e():1===c.status?window.location.href="/rates/list/torate/"+d.orderid:f(c.msg)},failure:function(){},end:function(){}}}):e()})}function e(){a.use("www-dialog",function(){j?j.open():j=i.Dialog.login({origin:"deal-feedback",galabel:"deal/feedback/login",loginRef:p})})}function f(a){l||(l=new k({id:"check-failure-dialog"})),l.showResult({type:"tip",width:"480px",title:a}),l.open(),l.set("autoHide",3)}var g,j,l,m=a.one("#deal-default .user-reviews"),n=c.dealId,o=c.isLogin,p=c.loginRef;m&&(g=m.one(".to-rate"),a.on("domready",function(){window.location.href.indexOf("#anchor-reviews")>0&&window.scrollTo(0,m.getY()-46),d()}))},initImageSlide:function(b){function c(a){var b,c,g=d(a);g.length&&(a.setData("imgLoadNum",0).setData("imgMaxHeight",0),b=f(a,g),c=e(g.length),a.append(b).append(c),h(a,c,b,g.length))}function d(b){var c=b.getAttribute("data-params"),d=c.split("|"),e=[],f=/^http:\/\/.+\.(jpg|png|gif)(\?v=\d+)?$/i;return a.Array.each(d,function(a){a=g(a.replace(/\n/g,"")),f.test(a)&&e.push(a)}),e}function e(b){var c,d=a.Node.create('<ul class="trigger"></ul>'),e=[];for(c=0;b>c;++c)e.push('<li><a href="javascript:void(0)">'+(c+1)+"</a></li>");return d.setHTML(e.join("")),d.hide(),d}function f(b,c){var d,e=a.Node.create('<ul class="sheet"></ul>'),f=c.length,g=[];for(d=0;f>d;++d)g.push("<li><div><p><img src="+c[d]+" /></p></div></li>");return e.setHTML(g.join("")),e.all("li").hide(),e.one("li").show(),e.all("img").on("load",function(a){var c=a.target.get("height");c>b.getData("imgMaxHeight")&&b.setData("imgMaxHeight",c),b.setData("imgLoadNum",b.getData("imgLoadNum")+1)}),e}function h(c,d,e,f){c.getData("imgLoadNum")===f?(e.setStyle("height",c.getData("imgMaxHeight")+"px"),d.show(),c.setStyle("marginBottom","25px"),a.use("w-tab",function(a){new a.mt.widget.Tab(d.all("li"),e.all("li"),b)})):window.setTimeout(function(){h(c,d,e,f)},500)}var i=a.all(".imageslide");if(i.size()){var j={animStyle:"fade",slideEnabled:!0,slideInterval:5e3};b=b||{},a.mix(b,j),i.each(function(a){c(a)})}},initDealAsync:function(b,c,d,e){var f,g,h=a.one(".J-bottom-list-wrapper"),i=a.one(".J-side-deallist-wrapper"),k=this.AsyncLoader,l=null,m=null,n=M.window;h.setStyle("visibility","hidden"),h.show(),f={action:j.appendTrackingParams("/deal/sidedeallist/"+b),async:null,method:"GET",callback:function(a){var b=a.data;b&&(i.append(b),i.show())}},g={action:"/deal/bottomdeallist/"+b,wrapper:h,method:"GET",async:null,callback:function(b){b.data&&(h.append(b.data),b.trackData&&(b.trackData.url="deal/default"),a.use("mt-log",function(a){a.mt.log.moduleview(b.trackData)}),h.setStyle("visibility","visible"),l.detach(),m.detach())}},e&&k.requestModule(f),d&&(k.winHeight=a.DOM.winHeight(),l=n.resize(function(){k.winHeight=a.DOM.winHeight(),k.asyncLoadWithCheck(g)},12),m=n.scroll(function(){k.asyncLoadWithCheck(g)},12),k.asyncLoadWithCheck(g))},AsyncLoader:{winHeight:0,asyncLoadWithCheck:function(b){var c=a.one(window),d=c.get("docScrollY"),e=b.wrapper.getY();e<=d+2*this.winHeight&&this.requestModule(b)},requestModule:function(a){var c=a.action,d=a.method?a.method:"GET";a.async||(a.async=b(c,{method:d,on:{success:function(b,c){var d=h.getEvalRes(c);a.callback(d)},failure:function(){}}}))}}}},"1.0.0",{requires:["www-base","soso-map","www-dialog","www-ratelist","www-hub","mt-component","www-tracker","mt-imageloader","www-add-cart","www-sku"]});
M.add("www-deal-firstscreen",function(a){function b(a){y&&(q(),y.delegate("click",function(a){var b=this.ancestor().ancestor();b&&(b.hasClass("deal-component-inline-text-folded")?a.target.setHTML("收起"):a.target.setHTML("显示全部"),b.toggleClass("deal-component-inline-text-folded"))},a))}function c(){var a=".J-toggle-more-schemes";y.delegate("click",function(){var a="deal-component-hide-other-scheme-patch",b=this.ancestor(),c=this.one("span");if(c){var d=c.getHTML();c.setHTML(c.getData("alternativeText")),c.setData("alternativeText",d)}b.toggleClass(a)},a)}function d(){function b(){return d?parseInt(d.get("value"),10)||1:1}function c(a){d&&d.set("value",a)}var d=a.one(".J-cart-quantity");return{get:b,set:c}}function e(){var b=a.one(".deal-component-remaining-time-text");if(!b)return void f();var c=parseInt(b.getData("remaining-time"),10)-Date.now();return c>=6048e5?void f():(b.removeClass("hidden"),I?void I.reset(c):(I=new G(c,{start:function(){var a=this,c=b.all(".J-slot");a.ndSlots=c,c&&c.each(function(b,c){b&&b.setHTML(a.time[c])})},step:function(a,b){try{this.ndSlots.item(b).setHTML(a)}catch(c){}}}),void I.tick()))}function f(){var b=a.one(".last-buyer-text");b&&b.removeClass("hidden")}function g(b){function c(a){var b=e.getData("max")-0;if(isNaN(a))return f.setHTML("请输入正确的购买数量"),!0;if(f.getHTML().length&&f.setHTML(""),y.one(".J-type-select")&&y.one(".J-type-selected")){var c=y.one(".J-type-selected").getData("dealgoodsrest");if(a>c&&b>c)return f.setHTML("还剩 "+c+"单"),!0}return 1>a?(f.setHTML("最少 1 件起售"),0===a&&setTimeout(function(){f.setHTML("")},3e3),!0):a>b?(f.setHTML("每人最多只能购买 "+b+"单"),a===b+1&&setTimeout(function(){f.setHTML("")},3e3),!0):(f.getHTML().length&&f.setHTML(""),!1)}function d(b){var c=y.one(".J-hotel-uni-info"),d=y.one(".J-hotel-cart-quantity");if(!c&&d.getData("basenum")){var e=d.getData("basenum");return void d.set("value",e*b)}var f=c.getData("countinfo");if(f){var g=a.JSON.parse(c.getData("countinfo")),h="",i="";for(i in g)g.hasOwnProperty(i)&&(g[i]*=b,h=h+i+"-"+g[i]+",");d&&d.set("value",g[i]),c.set("value",h.slice(0,-1))}}if(y){var e=y.one(".J-cart-quantity"),f=y.one(".deal-component-quantity-warning");y.delegate("click",function(a){var b=a.target,f=e.get("value")-0,g=f;c(g)||(g="-"===b.getData("action")?f-1:f+1,c(g)||(e.set("value",g),y.one(".J-hotel-cart-quantity")&&d(g)))},"button"),e&&(e.on("blur",function(){var a=e.get("value")-0;c(a)}),e.on("focus",function(){setTimeout(function(){e.select()},50)}))}}function h(b){var c=".J-component-share-tip-dialog";a.use("w-simpledialog",function(a){function d(){e&&(e._dialog._isHidden()?e.open():e.close())}if(y){var e=void 0;y.delegate("click",function(){e||(e=new a.mt.widget.SimpleDialog({id:"deal-component-share-dialog",node:a.one(c),width:118,content:b,location:"bl"})),d()},c)}})}function i(b){function c(b){a.use("mt-dialog",function(a){f=new a.mt.Dialog({id:"qq-dialog",width:"500px",title:"分享给QQ好友",content:'<div>通过QQ、电子邮件发送链接给你的朋友</div><input type="text" class="deal-share-qq-input" value="'+b+'" maxlength="40"><input class="deal-share-qq-copy" type="button" value="复制" class="btn btn-mini" style="display:none">'}),w.selectAndCopy(".deal-share-qq-input",".deal-share-qq-copy")})}function d(){f&&("open"===f._status?f.close():f.open())}function e(a){v("/deal/inviteurl/"+b+"/"+a,{method:"GET",on:{success:function(a,b){var d=x.getEvalRes(b);d.status&&c(d.data)},failure:function(){},end:d}})}var f=void 0;a.one("body").delegate("click",function(a){if(f)d();else{var c=a.target.getData("userid")||"";e(b,c)}},".deal-share-im")}function j(b){var c,d,e,f,g,h,i=!1;b.delegate("click",function(){var c=this.getData("priceId");h=this.ancestor(".J-price-selection-container"),d=b.all(".J-price-selection"),e=b.one(".J-price-id-input"),g=b.one(".J-hotel-uni-info"),f=b.one(".J-cart-quantity");var i=f.get("value");d.each(function(a){var b=a.one("i");a.removeClass("deal-detail-selection-item--current"),b&&a.removeChild(b)}),this.appendChild("<i></i>"),this.addClass("deal-detail-selection-item--current"),h.one(".price-selection").removeClass("price-selection--confirm"),e.setAttribute("value",c),g.setAttribute("value",c+"-"+i),g.setAttribute("data-countinfo",'{"'+c+'":"1"}'),D=d.indexOf(this),a.one(".J-price-range")&&a.one(".J-price-range").setHTML("<strong>"+this.getData("price")+"</strong>")},".J-price-selection"),b.delegate("click",function(e){return d=b.all(".J-price-selection"),c=b.one(".price-selection-container"),b.one(".deal-component-quantity-warning")&&""!==b.one(".deal-component-quantity-warning").get("innerHTML")?void e.halt():b.one(".deal-select-incomplete")?(e.halt(),void w.Sku.initNeedSelect(e,a.one(".deal-component-container"),"J-mini-cart-buy")):(d.each(function(a){a.hasClass("deal-detail-selection-item--current")&&(i=!0)}),void(c&&!i&&(e.halt(),c&&(c.one(".price-selection").addClass("price-selection--confirm"),C=!0))))},".J-mini-cart-buy")}function k(a){var b=!1;a.delegate("click",function(){var c=a.all(".uniprice-hide-tr");b?(c.removeClass("uniprice-show"),this.setHTML('全部<i class="arrow-up"></i>'),b=!1):(c.addClass("uniprice-show"),this.setHTML('收起<i class="arrow-down"></i>'),b=!0)},".uniprice-toggle")}function l(b){b&&b.one(".J-multi-appoint-buy-button")&&(b.delegate("click",function(a){var c=(b.one(".J-select-input"),b.one(".deal-component-purchase-button")),d=b.one(".J-hotel-multiappoint"),e=b.one(".J-multi-appoint-buy-button"),f=e.one("input"),g=(e.one("a"),b.one(".J-selected-poiid"));""===g.get("value")?(a.halt(),d.addClass("hotel-multiappoint"),e.show(),c.hide(),f.hide()):b.one("form").submit()},".J-mini-cart-buy"),b.delegate("click",function(){b.one(".J-hotel-multiappoint").removeClass("hotel-multiappoint"),b.one(".J-multi-appoint-buy-button").hide(),b.one(".deal-component-purchase-button").show()},".J-close"),b.delegate("click",function(a){a.currentTarget.hasClass("multi-appoint-buy")?b.one("form").submit():b.one(".J-mini-cart-buy").simulate("click")},".multi-appoint-buy, .J-multi-appoint-buy-button"),a.on("storeSelector:done",function(a){var c=(b.one(".J-select-input"),b.one(".J-multi-appoint-buy-button")),d=c.one("input"),e=c.one("a"),f=b.one(".J-selected-poiid");""!==f.get("value")&&(d.show(),e.hide())}))}function m(b){var c=b.one(".deal-component-campaigns-egregious-deal");if(c){var d=b.one(".J-egregious-deal-popover-countdown");if(d){var e=d.getData("duration");if(e){var f=d.getData("more-than-a-day");if(e=a.JSON.parse(e),e.now&&e.begin&&e.end&&!(e.now>e.end)){var g,h=c.hasClass("available-for-purchase");g=e.now<e.begin?e.begin-e.now:e.end-e.now,g=1e3*g;var i=d.all("span");F?F.reset(g):(F=new G(g,{start:function(){a.each(this.time,function(a,b){b&&(a=("0"+a).slice(-2),f||b--,i.item(b).setHTML(a))})},step:function(a,b){b&&(a=("0"+a).slice(-2),f||b--,i.item(b).setHTML(a))},done:function(){h&&location.reload()}}),F.tick()),c.removeClass("hidden")}}}}}function n(){var a=y.one(".deal-component-rating-sold-count");a&&a.removeClass("hidden")}function o(){var a=y.one(".deal-component-rating-stars");a&&a.removeClass("hidden")}function p(){var a=y.one(".deal-component-rating-comment-count");a&&a.removeClass("hidden")}function q(){var a=y.one(".J-toggle-inline");if(a){var b=a.previous();return b&&b.getDOMNode().scrollWidth!==b.getDOMNode().clientWidth?void 0:void a.remove()}}function r(e,f){if(e&&J){b(".J-toggle-inline"),E=f.slug;var g=a.one("#J-share-link-list").getHTML();M.load(function(){h(g)}),i(E),c(),H.init(),z=d(),A=z.get(),B=e.one(".J-hotel-cart-quantity")?".J-hotel-cart-quantity":".J-cart-quantity",D=-1,C=!1,l(e),j(e),k(e)}}function s(a,b){var c="referrer"in document?document.referrer:window.location.href;if(b.noupdate)return null;if(b.isUnavailable)return n(),o(),p(),null;var d=t(window.location.search),e={act:a,args:b.id,__referer:c};return d.ci&&d.co&&(e.ci=d.ci,e.co=d.co),d.cityid&&(e.cityid=d.cityid),d.poiid&&(e.poiid=d.poiid),e}function t(a){var b,c={},d=a.slice(1),e=d.split("&"),f=e.length;for(b=0;f>b;b++){var g=e[b].split("=")[0]+"",h=e[b].split("=")[1];c[g]=h}return c}function u(b,c,d){b.setHTML(c),d&&d.isMobileOnly&&a.mt.www.Deal.initMobileOnlyDialog(),n(),o(),p(),e(),m(y),z.set(A),w.Sku.initTypeSelection(y),w.Sku.initRemindClose(y),w.Sku.initTypeSelectAll(y),g(".deal-component-quantity"),w.AddCart.init(".J-add-mini-cart",B),a.mt.widget.init();var f=y.one(".J-fav-count");f&&f.removeClass("hidden"),J.addFavorite(E,"J-component-add-favorite");var h=y.one("form");if(h){a.use("www-tracker",function(a){a.mt.www.tracker.appendFormTrackingFields(h)});var i=a.one(".J-price-selection-container");if(i&&(i.removeClass("hidden"),C&&i.one(".price-selection").addClass("price-selection--confirm"),D>=0)){var j=i.all(".J-price-selection").item(D);j.addClass("deal-detail-selection-item--current"),j.appendChild("<i></i>")}}a.one(".uix-tooltip-tip")&&a.one(".uix-tooltip-tip").remove(!0),q()}var v=a.io,w=a.mt.www,x=a.mt.util,y=a.one(".J-deal-component-info");a.namespace("mt.www.DealFirstscreen");var z,A,B,C,D,E,F,G=function(){function a(a){a=parseInt(a/1e3,10);for(var b,d,e=c.slice(0),f=[];d=e.pop();)b=a%d,a-=b,a/=d,f.unshift(b);return f.unshift(a),f}function b(b,c){function d(){}this.time=a(b),c=c||{},this.start=c.start||d,this.step=c.step||d,this.done=c.done||d}var c=[0,24,60,60],d=function(a){var b=this;arguments.length||(a=b.time);for(var e=a.length;0===a[--e];);if(-1===e)return b.done(),b.stop();var f=a.pop();--f<0&&(f=c[a.length]-1,d.call(b,a)),b.step(f,a.length),a.push(f),arguments.length||(b.time=a)};return b.prototype.tick=function(){function a(){d.call(b)}var b=this;return b.start(),b.tick.handler=setInterval(a,1e3),b},b.prototype.stop=function(){try{clearInterval(this.tick.handler)}catch(a){}return this},b.prototype.reset=function(b){this.time=a(b),this.stop(),this.tick()},b}(),H=function(){function b(a){function b(a){var b=null;if(null===e&&(e=d.one("img")),a.currentTarget.hasClass("ui-slider__control--right")?(b=e.next("img"),null===b&&(b=d.one("img"))):a.currentTarget.hasClass("ui-slider__control--left")&&(b=e.previous("img"),null===b&&(b=d.all("img").slice(-1).item(0))),null!==b&&b!==e){e.removeClass("active"),b.addClass("active"),e=b;var f=b.getData("large-src");f&&f!==c.get("large-src")&&c.set("src",f)}}if(a){var c=a.one(".focus-view");if(c){c.onload&&(c.onload=null);var d=a.one(".candidates");if(d){d.removeClass("hidden");var e=d.one(".active"),f=a.all(".ui-slider__control");d.all("img").size()<2?f.each(function(a){a.remove()}):f.each(function(a){a.on("click",b)}),d.on("mouseover",function(a){var b=a.target;if(b&&"img"===b.get("tagName").toLowerCase()&&(!e||e!==b)){e.removeClass&&e.removeClass("active"),b.addClass("active"),e=b;var d=b.getData("large-src");d&&d!==c.get("large-src")&&c.set("src",d)}})}}}}var c=a.all(".simple-gallery");if(c)return{init:function(){c.each(b)}}}(),I=null,J=a.mt.www.Deal;a.mt.www.DealFirstscreen={init:r,beforeupdate:s,update:u,Countdown:G}},"0.0.1",{requires:["www-deal","www-add-cart","www-sku"]});